#!/usr/bin/env bash
# Exit on error
set -o errexit

echo "Installing npm packages..."
npm install

# Use our custom Chrome installer
echo "Running Chrome installer script..."
node chrome-installer.js

echo "Installing Chrome directly using puppeteer..."
npx puppeteer browsers install chrome

echo "Checking Chrome installation..."
if [ -d "/opt/render/.cache/puppeteer" ]; then
  echo "Found puppeteer cache directory"
  find /opt/render/.cache/puppeteer -name chrome -type f -exec ls -la {} \;
  find /opt/render/.cache/puppeteer -name chrome -type f -exec chmod +x {} \;
  
  # Create a symlink to ensure Chrome is accessible at runtime
  echo "Creating Chrome symlink for runtime access..."
  CHROME_PATH=$(find /opt/render/.cache/puppeteer -name chrome -type f | head -n 1)
  if [ -n "$CHROME_PATH" ]; then
    mkdir -p /opt/render/project/.render/
    ln -sf "$CHROME_PATH" /opt/render/project/.render/chrome
    echo "Created symlink: /opt/render/project/.render/chrome -> $CHROME_PATH"
    chmod +x /opt/render/project/.render/chrome
    
    # Store Chrome path in a file for runtime access
    echo "$CHROME_PATH" > /opt/render/project/.render/chrome-path.txt
    echo "Chrome path saved to /opt/render/project/.render/chrome-path.txt"
  else
    echo "WARNING: Could not find Chrome to create symlink"
  fi
else
  echo "WARNING: Puppeteer cache directory not found!"
fi